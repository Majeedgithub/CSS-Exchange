# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
Function Invoke-AnalyzerSecurityCve-2021-1730 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$KeySecuritySettings
    )
    Write-Verbose "Calling: $($MyInvocation.MyCommand)"
    #Description: Check for CVE-2021-1730 vulnerability
    #Fix available for: Exchange 2016 CU18+, Exchange 2019 CU7+
    #Fix: Configure Download Domains feature
    #Workaround: N/A

    if (((($SecurityObject.MajorVersion -eq [HealthChecker.ExchangeMajorVersion]::Exchange2016) -and
                ($SecurityObject.CU -ge [HealthChecker.ExchangeCULevel]::CU18)) -or
            (($SecurityObject.MajorVersion -eq [HealthChecker.ExchangeMajorVersion]::Exchange2019) -and
                ($SecurityObject.CU -ge [HealthChecker.ExchangeCULevel]::CU7))) -and
        $SecurityObject.ServerRole -ne [HealthChecker.ExchangeServerRole]::Edge) {

        Function TestDownloadDomainsConfiguration {
            param(
                [Parameter(Mandatory = $true)][object]$OwaVDirObject,
                [Parameter(Mandatory = $true)][bool]$DownloadDomainsEnabled
            )
            Write-Verbose "Calling: Test-DownloadDomainConfiguration"

            <#
                Unknown 0
                Download Domains disabled 1
                Download Domains enabled and configured as expected 2
                Download Domains enabled and external download host name = internal/external owa url 4
                Download Domains enabled but external download host name not set 8
                Download Domains enabled and internal download host name = internal/external owa url 16
                Download Domains enabled but internal download host name not set 32
                #>

            $downloadDomainsStatus = 0

            if ($DownloadDomainsEnabled) {
                $downloadDomainsStatus += 2

                if (![String]::IsNullOrEmpty($OwaVDirObject.ExternalDownloadHostName)) {

                    if (($OwaVDirObject.ExternalDownloadHostName -eq $OwaVDirObject.ExternalUrl.Host) -or
                            ($OwaVDirObject.ExternalDownloadHostName -eq $OwaVDirObject.InternalUrl.Host)) {
                        $downloadDomainsStatus += 4
                    }
                } else {
                    Write-Verbose "'ExternalDownloadHostName' is not configured"
                    $downloadDomainsStatus += 8
                }

                if (![String]::IsNullOrEmpty($OwaVDirObject.InternalDownloadHostName)) {

                    if (($OwaVDirObject.InternalDownloadHostName -eq $OwaVDirObject.ExternalUrl.Host) -or
                            ($OwaVDirObject.InternalDownloadHostName -eq $OwaVDirObject.InternalUrl.Host)) {
                        $downloadDomainsStatus += 16
                    }
                } else {
                    Write-Verbose "'InternalDownloadHostName' is not configured"
                    $downloadDomainsStatus += 32
                }

                return $downloadDomainsStatus
            } else {
                $downloadDomainsStatus += 1
                return $downloadDomainsStatus
            }
        }

        #TODO: Change this to not be a bitwise operation
        $downloadDomainsConfig = TestDownloadDomainsConfiguration -OwaVDirObject $SecurityObject.ExchangeInformation.GetOwaVirtualDirectory -DownloadDomainsEnabled $SecurityObject.ExchangeInformation.EnableDownloadDomains

        $downloadDomainsOrgDisplayValue = "True"
        $downloadDomainsOrgWriteType = "Green"

        if ($downloadDomainsConfig -band 1) {
            $downloadDomainsOrgDisplayValue = "False"
            $downloadDomainsOrgAdditionalDisplayValue = "Download Domains are not configured. You should configure them to be protected against CVE-2021-1730."
            $downloadDomainsOrgWriteType = "Red"
        }

        $downloadDomainsExtDisplayValue = "True"
        $downloadDomainsExtWriteType = "Green"

        if ($downloadDomainsConfig -band 4) {
            $downloadDomainsExtDisplayValue = "False"
            $downloadDomainsExtAdditionalDisplayValue = "Value is set to the same internal or external url as OWA. Please use a different url to reach a protected state against CVE-2021-1730."
            $downloadDomainsExtWriteType = "Red"
        } elseif ($downloadDomainsConfig -band 8) {
            $downloadDomainsExtDisplayValue = "False"
            $downloadDomainsExtAdditionalDisplayValue = "Value not set. Please configure to reach a protected state against CVE-2021-1730."
            $downloadDomainsExtWriteType = "Red"
        }

        $downloadDomainsIntDisplayValue = "True"
        $downloadDomainsIntWriteType = "Green"

        if ($downloadDomainsConfig -band 16) {
            $downloadDomainsIntDisplayValue = "False"
            $downloadDomainsIntAdditionalDisplayValue = "Value is set to the same internal or external url as OWA. Please use a different url to reach a protected state against CVE-2021-1730."
            $downloadDomainsIntWriteType = "Red"
        } elseif ($downloadDomainsConfig -band 32) {
            $downloadDomainsIntDisplayValue = "False"
            $downloadDomainsIntAdditionalDisplayValue = "Value not set. Please configure to reach a protected state against CVE-2021-1730."
            $downloadDomainsIntWriteType = "Red"
        }

        $AnalyzeResults | Add-AnalyzedResultInformation -Name "Download Domains Enabled" -Details $downloadDomainsOrgDisplayValue `
            -DisplayGroupingKey $KeySecuritySettings `
            -DisplayWriteType $downloadDomainsOrgWriteType `
            -AddHtmlDetailRow $true

        if (![string]::IsNullOrEmpty($downloadDomainsOrgAdditionalDisplayValue)) {
            $AnalyzeResults | Add-AnalyzedResultInformation -Details $downloadDomainsOrgAdditionalDisplayValue `
                -DisplayGroupingKey $KeySecuritySettings `
                -DisplayWriteType "Red" `
                -DisplayCustomTabNumber 2 `
                -AddHtmlDetailRow $true
        } else {

            $AnalyzeResults | Add-AnalyzedResultInformation -Name "ExternalDownloadHostName configured correctly" -Details $downloadDomainsExtDisplayValue `
                -DisplayGroupingKey $KeySecuritySettings `
                -DisplayWriteType $downloadDomainsExtWriteType `
                -DisplayCustomTabNumber 2 `
                -AddHtmlDetailRow $true

            if (![string]::IsNullOrEmpty($downloadDomainsExtAdditionalDisplayValue)) {
                $AnalyzeResults | Add-AnalyzedResultInformation -Details $downloadDomainsExtAdditionalDisplayValue `
                    -DisplayGroupingKey $KeySecuritySettings `
                    -DisplayWriteType "Red" `
                    -DisplayCustomTabNumber 2 `
                    -AddHtmlDetailRow $true
            }

            $AnalyzeResults | Add-AnalyzedResultInformation -Name "InternalDownloadHostName configured correctly" -Details $downloadDomainsIntDisplayValue `
                -DisplayGroupingKey $KeySecuritySettings `
                -DisplayWriteType $downloadDomainsIntWriteType `
                -DisplayCustomTabNumber 2 `
                -AddHtmlDetailRow $true

            if (![string]::IsNullOrEmpty($downloadDomainsIntAdditionalDisplayValue)) {
                $AnalyzeResults | Add-AnalyzedResultInformation -Details $downloadDomainsIntAdditionalDisplayValue `
                    -DisplayGroupingKey $KeySecuritySettings `
                    -DisplayWriteType "Red" `
                    -DisplayCustomTabNumber 2 `
                    -AddHtmlDetailRow $true
            }
        }

        if ($downloadDomainsOrgWriteType -eq "Red" -or
            $downloadDomainsExtWriteType -eq "Red" -or
            $downloadDomainsIntWriteType -eq "Red") {

            $AnalyzeResults | Add-AnalyzedResultInformation -Details "Configuration instructions: https://aka.ms/HC-DownloadDomains" `
                -DisplayGroupingKey $KeySecuritySettings `
                -DisplayWriteType "Red" `
                -DisplayCustomTabNumber 2 `
                -AddHtmlDetailRow $true

            $Script:AllVulnerabilitiesPassed = $false
        }
    } else {
        Write-Verbose "Download Domains feature not available because we are on: $($SecurityObject.MajorVersion) $($SecurityObject.CU) or on Edge Transport Server"
    }
}
